# PHPMaskedGet
A set of functions for masking data sent in GET requests between PHP scripts.

PHPMaskedGet allows you to pass data between PHP scripts without including the data itself in the GET request. This has the following advantages:

1. The user cannot see the data, so you can pass sensitive data between scripts that you might not want the user to see.
2. The data in the GET request will also not appear in the user's browser history.
3. Data passed between scripts can be any PHP variable type, including arrays. This means you can pass data of any kind without having to convert them to string format (e.g. serialising arrays into strings and then back again).
4. This could help to protect against DDOS and database attacks by hiding database values passed between scripts.
5. It also prevents manipulating the data which is returned by scripts, which is possible by editing the URL (for example, if database ID values are passed in directly).

Incorporating PHPMaskedGet into existing PHP scripts is straightforward, and consists of the following steps:

1. Including the header in the PHP scripts which need to send and receive masked data.
2. Replacing parts of the script which print GET requests (e.g. by constructing URLs which are echoed to the browser) so they print values generated by PHPMaskedGet.
3. Replacing functions which retrieve values from `$_GET[]` so they are retrieved from PHPMaskedGet instead.

Two scripts are included in this repository:

- `maskedGET.php`: includes the functions needed for masking data and retrieving masked data.
- `randomstring.php`: includes a convenience function used for generating keys.


PHPMaskedGet provides the following functions.

### Initialisation functions
- `maskedGETReset()`: initialises the array which stores the masked data.
- `maskedGETClear()`: removes the masked data.

### Value setting functions
- `maskedGETSetValues()`: removes any existing masked values, and masks and adds the array of values passed to the function.
- `maskedGETAddValue()`: masks the provided value, adds it to the array of masked values, and returns the array key for the value.

### Value getting functions
- `maskedGETGetValue()`: returns the value associated with the provided key, or `false` if no value was found. The key argument should be set to the variable name in `$_GET[]` which contains the key. If no key is provided, the function assumes that the key is stored in `$_GET['k']`.
- `maskedGETGetValueOrDie()`: attempts to retrieve the value associated with the provided key in the same way as `maskedGETGetValue()`, but causes the PHP script to die if no value is found. This is useful for scripts which run in the background (e.g. though AJAX or hidden iframes) so you can terminate execution if an incorrect key was provided. This should only happen if an error was made when adding the values to the masked array, or if an attacker is attempting random or old keys.
- `maskedGETGetKey()`: returns the key associated with the provided value, or false if the value does not exist in the array of masked values. This is useful if you added an array of values and then want to know the key associated with one of the values.

### Other functions
- `maskedGetTrim()`: trims the array of masked values down to the specified size. The oldest values are discarded. This is useful for ensuring the session array does not become overly large, while allowing a cache of older values to remain. This will mean older keys will continue to work for a time should the user reload a page or use the browser history to go back to a previously loaded page.


## Examples
### Traditional get request
```php
/*
userlist.php
*/
  
$users = getUsersFromDatabase(); // Retrieve user data from database
    
for ($users as $user) {
  $name = $user['name']; //Get the user's name from the database result
  $userid = $user['userid']; //Get the user's ID from the database result
  echo "<a href='viewuser.php?userid=$userid'>View user $name</a><br>"; //Print a link to the user's profile page. The database user id number is visible in the GET request
}
```

```php
/*
viewuser.php
*/

session_start();
  
$userid = $_GET['userid']; //Get the passed user id directly from the GET request. This could be manipulated by editing the URL so it would show other users' details!
$userdetails = getDetailsForUserID($userid); //Use the userID to get and print details of the user
$name = $userdetails['name'];
echo "Details for user $name";
```

### Using PHPMaskedGet

```php
/*
userlist.php
*/
    
session_start();
    
$users = getUsersFromDatabase(); // Retrieve user data from database
    
for ($users as $user) {
  $name = $user['name']; //Get the user's name from the database result
  $userid = $user['userid']; //Get the user's ID from the database result
  $key = maskedGETAddValue($userid); //Mask the userid
  echo "<a href='viewuser.php?k=$key'>View user $name</a><br>"; //Print a link to the user's profile page. Only the key to the masked value is visible in the GET request
}
```

```php
/*
viewuser.php
*/

session_start();

$userid = maskedGETGetValue(); //Get the masked user id. Manipulating the key in the URL is very unlikely to result in a match to a valid value
if (!$userid) {
  echo "Invalid user ID";
  exit;
}
$userdetails = getDetailsForUserID($userid); //Use the userID to get and print details of the user
$name = $userdetails['name'];
echo "Details for user $name";
```
